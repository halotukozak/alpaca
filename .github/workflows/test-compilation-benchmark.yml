name: Test Compilation Benchmark

on:
  pull_request:
    branches: [ master ]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          path: 'current'

      - name: Checkout Base Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: 'base'

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Cache Mill dependencies
          uses: actions/cache@v5
          with:
            path: |
              ~/.cache/coursier
              ~/.cache/mill
            key: ${{ runner.os }}-mill-${{ hashFiles('build.mill') }}
            restore-keys: |
              ${{ runner.os }}-mill-
              
      - name: Install Hyperfine
        run: sudo apt-get install -y hyperfine

      - name: Benchmark
        id: benchmark
        run: |
          # Helper function to warm up and benchmark
          run_bench() {
            local dir=$1
            cd $dir
            ./mill compile > /dev/null 2>&1
            # Run 1 warmup, then 5 timed runs
            hyperfine --warmup 1 --runs 5 "./mill test.compile" --export-json ../$dir.json
            cd ..
          }

          echo "Benchmarking Base branch..."
          run_bench "base"
          
          echo "Benchmarking Current branch..."
          run_bench "current"

      - name: Compare Results
        id: compare
        run: |
          BASE_TIME=$(jq '.results[0].mean' base.json)
          CURR_TIME=$(jq '.results[0].mean' current.json)
          
          DIFF=$(echo "$CURR_TIME - $BASE_TIME" | bc)
          PERC=$(echo "scale=2; ($DIFF / $BASE_TIME) * 100" | bc)
          
          # Pass variables to next steps
          echo "base_sec=$(printf "%.2f" $BASE_TIME)" >> $GITHUB_OUTPUT
          echo "curr_sec=$(printf "%.2f" $CURR_TIME)" >> $GITHUB_OUTPUT
          echo "diff_sec=$(printf "%.2f" $DIFF)" >> $GITHUB_OUTPUT
          echo "perc=$PERC" >> $GITHUB_OUTPUT

      - name: Upsert PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { base_sec, curr_sec, diff_sec, perc } = steps.compare.outputs;
            const emoji = parseFloat(diff_sec) > 0 ? 'âš ï¸' : 'âœ…';
            const status = parseFloat(diff_sec) > 0 ? 'slower' : 'faster';
            
            const body = `### ðŸ“Š Test Compilation Benchmark
            | Branch | Average Time |
            | :--- | :--- |
            | **Base (${{ github.base_ref }})** | ${base_sec}s |
            | **Current (${{ github.head_ref }})** | ${curr_sec}s |
            
            **Result:** Current branch is ${Math.abs(diff_sec)}s ${status} (${Math.abs(perc)}%) ${emoji}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('### ðŸ“Š Test Compilation Benchmark'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
