name: Label Issues

on:
  issues:
    types: [ opened, edited ]
  pull_request:
    types: [ opened, edited ]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  label-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Label issues using GitHub Copilot
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue || context.payload.pull_request;
            const title = issue.title || '';
            const body = issue.body || '';
            const itemType = context.payload.issue ? 'issue' : 'pull request';
            
            // Available labels and their descriptions
            const availableLabels = {
              'Parser': 'Issues related to parser functionality, syntax analysis, grammar rules, AST generation, shift-reduce conflicts, LR parsing',
              'Lexer': 'Issues related to lexer functionality, tokenization, regex patterns, lexical analysis',
              'bug': 'Something isn\'t working correctly - errors, failures, crashes, exceptions',
              'documentation': 'Improvements or additions to documentation, guides, tutorials, examples',
              'enhancement': 'Feature requests or improvements to existing functionality',
              'testing': 'Issues related to tests, test coverage, or testing infrastructure',
              'build': 'Issues related to the build system, CI/CD, compilation, Mill, SBT',
              'performance': 'Performance optimization issues - slow execution, efficiency improvements',
              'error-handling': 'Issues related to error messages, diagnostics, or warnings',
              'API': 'Issues related to the public API or user-facing interfaces',
              'refactoring': 'Code quality improvements or restructuring without changing functionality'
            };
            
            // Build label descriptions for the prompt
            const labelDescriptions = Object.entries(availableLabels)
              .map(([label, desc]) => `- ${label}: ${desc}`)
              .join('\n');
            
            // Prepare the prompt for GitHub Models API
            const systemPrompt = `You are an expert issue triaging assistant for the Alpaca project, a Scala 3 lexer and parser library. Your task is to analyze ${itemType}s and assign appropriate labels from a predefined list.

            Available labels:
            ${labelDescriptions}

            Analyze the ${itemType} and return ONLY a JSON array of label names that should be applied. Return an empty array if no labels match. Do not include any explanation or additional text.

            Example response format: ["Parser", "bug", "performance"]`;

            const userPrompt = `Please analyze this ${itemType} and suggest appropriate labels:

            Title: ${title}

            Body:
            ${body}

            Return only a JSON array of applicable label names.`;

            try {
              console.log(`Analyzing ${itemType} #${issue.number}: "${title}"`);
              
              // Call GitHub Models API (using GPT-4o)
              const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`
                },
                body: JSON.stringify({
                  messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                  ],
                  model: 'gpt-4o',
                  temperature: 0.3,
                  max_tokens: 150
                })
              });

              if (!response.ok) {
                const errorText = await response.text();
                console.log(`API request failed: ${response.status} ${response.statusText}`);
                console.log(`Error details: ${errorText}`);
                throw new Error(`GitHub Models API returned ${response.status}: ${errorText}`);
              }

              const data = await response.json();
              const aiResponse = data.choices[0].message.content.trim();
              console.log(`AI response: ${aiResponse}`);
              
              // Parse the AI response (expecting JSON array)
              let suggestedLabels;
              try {
                // Try to extract JSON array from the response
                const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                  suggestedLabels = JSON.parse(jsonMatch[0]);
                } else {
                  suggestedLabels = JSON.parse(aiResponse);
                }
              } catch (parseError) {
                console.log(`Failed to parse AI response as JSON: ${parseError.message}`);
                console.log(`Raw response: ${aiResponse}`);
                suggestedLabels = [];
              }
              
              // Validate and filter suggested labels
              const validLabels = suggestedLabels.filter(label => 
                Object.keys(availableLabels).includes(label)
              );
              
              if (validLabels.length === 0) {
                console.log('No valid labels suggested by AI');
                return;
              }
              
              console.log(`AI suggested labels: ${validLabels.join(', ')}`);
              
              // Get existing labels on the issue
              const existingLabels = issue.labels.map(label => label.name);
              
              // Only add labels that don't already exist
              const newLabels = validLabels.filter(label => !existingLabels.includes(label));
              
              if (newLabels.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: newLabels
                });
                console.log(`✅ Successfully added labels: ${newLabels.join(', ')}`);
              } else {
                console.log('All suggested labels already exist on the issue');
              }
              
            } catch (error) {
              console.log(`❌ Error during AI labeling: ${error.message}`);
              console.log('Full error:', error);
              // Don't fail the workflow, just log the error
            }
