//| mill-version: 1.1.2
//| mill-jvm-version: 21
//| mvnDeps:
//| - com.lihaoyi::mill-contrib-scoverage:$MILL_VERSION
//| - com.lihaoyi::mill-contrib-sonatypecentral:$MILL_VERSION
//| - com.lihaoyi::mill-contrib-jmh:$MILL_VERSION
//| - org.scala-steward::scala-steward-mill-plugin::0.19.0
package build

import mill.*
import mill.scalalib.*
import mill.scalalib.publish.*
import mill.contrib.scoverage.ScoverageModule
import mill.contrib.jmh.JmhModule
import mill.util.VcsVersion

object `package` extends ScalaModule with ScoverageModule with SonatypeCentralPublishModule:
  def scalaVersion = "3.8.1"

  def scoverageVersion = "2.5.2"

  override def scalacOptions = Seq(
    "-deprecation",
    "-feature",
    // "-explain",
    "-new-syntax",
    "-unchecked",
    "-language:noAutoTupling",
    "-Vprofile",
    "-Xprint-inline",
    // "-Ycheck:all", // cannot be enabled when scoverage used :/
    "-Ycheck:macros",
    // "-Ydebug-error",
    "-Ydebug-flags",
    "-Ydebug-missing-refs",
    "-Yexplain-lowlevel",
    "-Yexplicit-nulls",
    // "-Yprint-debug",
    // "-Xprint:postInlining",
    // "-Xprint-suspension",
    // "-Vprint:typer",
    "-Wsafe-init",
    "-Yshow-suppressed-errors",
    "-Yshow-var-bounds",
    "-Werror",
    "-Wunused:all",
    "-experimental",
    "-preview",
    s"-Xmacro-settings:debugDirectory=$moduleDir/debug,enableVerboseNames=true",
    // "-Xmacro-settings:trace=file",
    //  "-Yprofile-enabled",
    //  s"-Yprofile-trace:$moduleDir/debug/compile-trace.json",
  )

  override def scalaDocOptions = Task {
    Seq(
      "-project",
      "alpaca",
      "-project-version",
      publishVersion(),
      "-project-logo",
      s"$moduleDir/docs/_assets/images/logo.png",
      "-project-footer",
      "made with ❤️ and coffee",
      "-social-links:github::https://github.com/halotukozak/alpaca",
      "-snippet-compiler:compile",
      s"-source-links:$moduleDir=github://halotukozak/alpaca/master",
      "-revision:master",
    )
  }

  def artifactName = "alpaca"

  def publishVersion = Task(VcsVersion.vcsState().format())

  def pomSettings = PomSettings(
    description = "Another Lexer Parser And Compiler Alpaca",
    organization = "io.github.halotukozak",
    url = "https://halotukozak.github.io/alpaca/docs/index.html",
    licenses = Seq(License.MIT),
    versionControl = VersionControl.github("halotukozak", "alpaca"),
    developers = Seq(
      Developer("halotukozak", "Bartłomiej Kozak", "https://github.com/halotukozak"),
      Developer("Corvette653", "Bartosz Buczek", "https://github.com/Corvette653"),
    ),
  )

  def mvnDeps = Seq(
    mvn"com.github.marianobarrios:dregex:0.9.0",
    mvn"org.jparsec:jparsec:3.1",
    mvn"org.slf4j:slf4j-api:2.0.17",
    mvn"org.slf4j:slf4j-simple:2.0.17",
    mvn"com.softwaremill.ox::core:1.0.3",
  )

  object test extends ScalaTests with TestModule.ScalaTest with ScoverageTests:
    def scalaTestVersion = "3.2.19"

  object benchmarks extends ScalaModule with JmhModule:
    def scalaVersion = build.scalaVersion()
    def moduleDeps = Seq(build)
    def jmhCoreVersion = "1.37"
    override def scalacOptions = Seq("-experimental", "-preview", "-Yretain-trees")

    trait BenchmarkScalaModule extends ScalaModule:
      def sharedSources = Task.Source(moduleDir / os.up / "shared" / "src")
      override def sources = Task {
        super.sources() ++ Seq(sharedSources())
      }
      override def forkWorkingDir = Task(moduleDir / os.up)
      override def scalacOptions = build.scalacOptions()

    object alpaca extends BenchmarkScalaModule:
      def scalaVersion = build.scalaVersion()
      override def scalacOptions = super.scalacOptions() ++ Seq("-experimental", "-Yretain-trees")
      def moduleDeps = Seq(build)

    object fastparse extends BenchmarkScalaModule:
      def scalaVersion = "3.3.1"
      def mvnDeps = Seq(mvn"com.lihaoyi::fastparse:3.0.2")

    def runAll() = Task.Command {
      val root = moduleDir
      os.call(("python3", "inputs/generate_tests.py"), cwd = root, stdout = os.Inherit)
      os.call((root / os.up / "mill", "benchmarks.alpaca.run"), cwd = root / os.up, stdout = os.Inherit)
      os.call((root / os.up / "mill", "benchmarks.fastparse.run"), cwd = root / os.up, stdout = os.Inherit)
      os.call(("python3", "sly/benchmark.py"), cwd = root, stdout = os.Inherit)
      println("\n=== All benchmarks completed. Results in outputs/ ===")
    }
